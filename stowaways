#!/usr/bin/env sh

USR_DIRS="${USR_DIRS:-clang,dirs, ghostty,git,i3,i3-scrot,nvim,oh-my-zsh,tmux,zsh}"
SYS_DIRS="${SYS_DIRS:-bin,fonts,i8k}"
DOTFILES="${DOTFILES:-$HOME/.dotfiles}"

# oh-my-zsh deps
git clone https://github.com/zsh-users/zsh-autosuggestions ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions
git clone https://github.com/zsh-users/zsh-syntax-highlighting ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
git clone https://github.com/zsh-users/zsh-history-substring-search ~/.oh-my-zsh/custom/plugins/zsh-history-substring-search

# Prevent clash with system .zshrc, user.dirs
rm "$HOME/.zshrc"
rm "$HOME/.config/user-dirs.dirs"

# Stow dirs
if ! command -v stow >/dev/null 2>&1; then
  echo "Error: GNU Stow not found in PATH."
  exit 1
fi

cd "$DOTFILES" || { echo "Error: Unable to navigate to $DOTFILES"; exit 1; }

IFS=',' read -r -a sys_dirs <<< "$SYS_DIRS"
for dir in "${sys_dirs[@]}"; do
  echo "Stowing $dir..."
  sudo stow -D -t / "$dir" 2>/dev/null
  sudo stow -t / "$dir"
done
sudo fc-cache -fv
IFS=',' read -r -a usr_dirs <<< "$USR_DIRS"
for dir in "${usr_dirs[@]}"; do
  echo "Stowing $dir..."
  stow -D "$dir" 2>/dev/null
  stow "$dir"
done

# Rename user dirs
for pair in "Desktop:desktop" "Downloads:downloads" "Templates:templates" "Public:public" \
            "Documents:documents" "Music:music" "Pictures:pictures" "Videos:videos"; do
  src=$(printf "%s" "$pair" | cut -d: -f1)
  dst=$(printf "%s" "$pair" | cut -d: -f2)
  if [ -d "$HOME/$src" ] && [ ! -e "$HOME/$dst" ]; then
    mv "$HOME/$src" "$HOME/$dst"
    echo "Moved $HOME/$src to $HOME/$dst"
  fi
done
mkdir "$HOME/git"

sudo modprobe -r i8k 2>/dev/null
sudo modprobe i8k force=1
